<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>#HEXXED - Color Mixing Laboratory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
    <script type="importmap">
      {
        "imports": {
          "three": "https://esm.sh/three@0.160.0?dev",
          "three/": "https://esm.sh/three@0.160.0&dev/",
          "tween.js": "https://esm.sh/@tweenjs/tween.js@21.0.0",
          "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.39.0"
        }
      }
    </script>
    <style>
      #titleParticlesCanvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1; 
        pointer-events: none; 
      }
      body {
        margin: 0;
        padding: 0;
    overflow: hidden;
    font-family: 'Arial', sans-serif;
    background: linear-gradient(135deg, #2d1b69, #11001c, #4a0e67, #1f002e);
    background-size: 400% 400%;
    animation: animatedBackground 25s ease infinite;
}
@keyframes animatedBackground {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
* {
        box-sizing: border-box; /* Ensures padding and border don't add to element's total width/height */
      }
      #gameContainer {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex; 
        align-items: center;
        justify-content: center; 
      }
      #gameArea { 
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 100;
        display: none; 
      }
      #titleScreen {
        background: rgba(17, 0, 28, 0.85); 
        backdrop-filter: blur(5px);
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        color: white;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5), 
                    0 0 15px rgba(171, 112, 255, 0.3), /* Subtle violet glow */
                    0 0 30px rgba(0, 200, 255, 0.2); /* Subtle cyan glow for depth */
        z-index: 200; /* Above game area */
        width: 100%;
        max-width: 450px; /* Control max width */
        transition: box-shadow 0.5s ease-in-out; /* Smooth transition for shadow */
        display: flex; /* Ensure it's visible by default and manages children as flex items */
        flex-direction: column; /* Stack children vertically */
        align-items: center; /* Center children horizontally */
        justify-content: center; /* Center children vertically if titleScreen has a fixed height or takes more space */
}
#titleScreen:hover { /* Optional: enhance glow on hover */
    box-shadow: 0 12px 35px rgba(0,0,0,0.6), 
                0 0 25px rgba(171, 112, 255, 0.45), 
                0 0 40px rgba(0, 200, 255, 0.3);
}
@keyframes rainbowText {
        0% { color: #ff0000; } /* Red */
        16% { color: #ff7f00; } /* Orange */
        33% { color: #ffff00; } /* Yellow */
        50% { color: #00ff00; } /* Green */
        67% { color: #0000ff; } /* Blue */
        83% { color: #4b0082; } /* Indigo */
        100% { color: #8f00ff; } /* Violet */
    }
    #titleScreen h1 {
      font-size: 3.5em; /* Slightly larger */
      font-weight: bold;
      margin-bottom: 15px;
      background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00, #ff00ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% 200%;
      animation: gradientShift 5s ease infinite, subtlePulse 2s infinite alternate;
      text-shadow: 0 0 5px rgba(255,255,255,0.3), 
                   0 0 10px rgba(255,105,180,0.5), /* Hot pink glow */
                   0 0 15px rgba(0,255,255,0.4); /* Cyan glow */
    }
    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    @keyframes subtlePulse {
        from { opacity: 0.9; }
        to { opacity: 1; }
    }
    #titleScreen p {
      font-family: 'Luckiest Guy', cursive;
      font-size: 1.5em; /* Adjusted for Luckiest Guy */
      margin-bottom: 30px;
      line-height: 1.3;
      background: linear-gradient(90deg, #ff7e5f, #feb47b, #86a8e7, #91eae4, #ff9f80, #ff7e5f);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 400% 400%;
      animation: gradientShift 12s ease infinite alternate; /* Slower and alternating animation */
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Adjusted shadow for Luckiest Guy */
    }
    .authForm input {
        display: block;
    width: calc(100% - 22px); /* Account for padding */
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 1em;
    transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Smooth transitions */
    box-shadow: 0 0 5px rgba(255,255,255,0.1); /* Initial subtle glow */
}
.authForm input:focus {
    outline: none;
    border-color: #87CEFA; 
    box-shadow: 0 0 10px rgba(135, 206, 250, 0.7), 
                0 0 5px rgba(255, 105, 180, 0.4); 
}
.authForm input::placeholder {
    color: #bbb;
}
.authForm button {
      border: none;
      border-radius: 10px;
      padding: 14px 24px; 
      color: white;
      font-weight: bold;
      font-size: 1.05em; 
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      margin: 8px 5px; /* Adjusted margin */
      min-width: 130px; /* Slightly larger min-width */
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #loginButton {
      background: linear-gradient(135deg, #6dd5ed, #2193b0); /* Blue-cyan gradient */
      box-shadow: 0 4px 15px rgba(33, 147, 176, 0.4);
    }
    #loginButton:hover {
      transform: translateY(-3px) scale(1.03);
      box-shadow: 0 6px 20px rgba(33, 147, 176, 0.5);
      background: linear-gradient(135deg, #79e0f5, #27a8c7); /* Lighter hover */
    }
    #signupButton {
      background: linear-gradient(135deg, #ff9a9e, #fecfef); /* Pink-lilac gradient */
      box-shadow: 0 4px 15px rgba(254, 207, 239, 0.4);
    }
    #signupButton:hover {
      transform: translateY(-3px) scale(1.03);
      box-shadow: 0 6px 20px rgba(254, 207, 239, 0.5);
      background: linear-gradient(135deg, #ffacad, #fde3f7); /* Lighter hover */
    }
    #authMessage {
        margin-top: 15px;
        color: #ff6b6b;
        min-height: 20px; /* Reserve space for messages */
      }
      #topBar {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        pointer-events: auto;
        flex-wrap: wrap; 
        gap: 8px; /* Add gap for wrapped items */
      }
      #encyclopediaToggleButton {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 8px 12px;
        color: white;
        font-size: 20px; /* For emoji */
        cursor: pointer;
        /* margin-left: 10px; Removed, using gap in #topBar */
      }
      #leaderboardToggleButton {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 8px 12px;
        color: white;
        font-size: 20px; /* For emoji */
        cursor: pointer;
      }
      #battleModeButton { /* Style similar to other top bar buttons */
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 8px 12px;
        color: white;
        font-size: 20px; /* For emoji or icon text */
        cursor: pointer;
        /* margin-left: 10px; /* Optional: if not relying solely on gap */
      }
      #colorCounter {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 10px 20px;
        color: white;
        font-weight: bold;
        font-size: 18px;
      }
      #instructions {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 10px 20px;
        color: white;
        font-size: 14px;
        text-align: center;
        /* flex-basis: 100%; Removed, let flexbox handle wrapping */
        /* order: 1; Re-evaluating order for mobile */
        margin: 0; /* Remove fixed margin, use gap */
      }
      #challengeDisplay {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 10px 20px;
        color: #ffda77; /* Gold-ish color for challenge text */
        font-size: 14px;
        text-align: center;
        /* margin-top: 10px; Removed, using gap in #topBar */
      }
      #selectedColors {
        position: absolute;
        top: 90px; /* Position below topBar */
        right: 15px;
        width: 220px; 
        max-height: calc(100vh - 180px); /* Avoid overlap with top/bottom elements */
        background: rgba(17, 0, 28, 0.75); /* Dark, thematic background */
        backdrop-filter: blur(5px);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        pointer-events: auto;
        overflow-y: auto;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      }
      .selectedColor { /* Styles for each item in the new right panel */
        display: flex;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.05);
        padding: 8px;
        border-radius: 6px;
        color: white;
        height: auto; /* Auto height based on content */
        width: 100%; /* Full width of parent */
        border: 1px solid rgba(255, 255, 255, 0.15);
        transition: background-color 0.2s ease;
      }
      .selectedColor:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }
      .selectedColorSwatch {
        width: 28px;
        height: 28px;
        border-radius: 5px;
        margin-right: 10px;
        border: 1px solid rgba(255,255,255,0.3);
        flex-shrink: 0; /* Prevent shrinking */
      }
      .selectedColorName {
        font-size: 0.9em;
        flex-grow: 1; /* Take remaining space */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      #mixButton {
        background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
        border: none;
        border-radius: 30px;
        padding: 15px 30px;
        color: white;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }
      #mixButton:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }
      #mixButton:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      /* #encyclopediaPanel styles removed, replaced by #fullscreenEncyclopedia */
      #fullscreenEncyclopedia {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: radial-gradient(circle, rgba(45,27,105,1) 0%, rgba(17,0,28,1) 100%),
                    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        background-color: #0a0010; /* Fallback if SVG fails */
        color: white;
        z-index: 500; /* High z-index to cover everything */
        display: none; /* Hidden by default */
        padding: 20px;
        overflow-y: auto;
        box-sizing: border-box;
      }
      #fsEncyclopediaHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0; /* Remove bottom margin as tabs will be directly below */
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      #encyclopediaTabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .encyclopediaTabButton {
        padding: 10px 20px;
        cursor: pointer;
        background: transparent;
        border: none;
        color: #ccc;
        font-size: 1em;
        border-bottom: 3px solid transparent;
        transition: color 0.2s, border-bottom-color 0.2s;
      }
      .encyclopediaTabButton:hover {
        color: white;
      }
      .encyclopediaTabButton.active {
        color: #ffda77;
        border-bottom-color: #ffda77;
        font-weight: bold;
      }
      .encyclopediaTabPanel {
        display: none; /* Hidden by default */
      }
      .encyclopediaTabPanel.active {
        display: block; /* Show active panel */
      }
      #fsEncyclopediaTitle {
        font-size: 2em; /* Larger title */
        color: #ffda77; /* Goldenrod for title */
        text-shadow: 0 0 10px #ffda77, 0 0 5px #ff8c00;
        font-family: 'Georgia', serif; /* More thematic font */
        margin-left: 10px; /* Add some space if tabs are next to it, or adjust header structure */
      }
      #closeEncyclopediaButton {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        color: #ffda77;
        font-size: 20px;
        width: 36px;
        height: 36px;
        cursor: pointer;
        line-height: 34px;
        text-align: center;
        transition: background-color 0.2s, box-shadow 0.2s;
      }
      #closeEncyclopediaButton:hover {
        background-color: rgba(255,218,119,0.2);
        box-shadow: 0 0 8px #ffda77;
      }
      /* #encyclopediaControls will be inside a tab panel now */
      /* #encyclopediaControls {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
      } */
      #encyclopediaControls label {
        font-size: 0.9em;
        color: #ccc;
      }
      #sortColorsDropdown {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        padding: 8px 12px;
        font-size: 0.9em;
        outline: none;
      }
      #sortColorsDropdown option {
        background: #1e1247;
        color: white;
      }
      #colorGrid { /* Styles for colorGrid within the new page */
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); /* Slightly larger, more prominent swatches */
        gap: 10px;
        margin-bottom: 20px;
      }
      .colorSwatch {
        width: 100%; 
        padding-bottom: 100%; 
        border-radius: 10px; /* Softer radius */
        border: 2px solid rgba(255, 255, 255, 0.2);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }
      .colorSwatch:hover {
        transform: scale(1.08);
        box-shadow: 0 0 20px rgba(255,255,255,0.6);
        border-color: #ffda77;
      }
      .colorSwatch.pinned {
        border-color: #87CEFA; /* Light sky blue to indicate selection */
        transform: scale(1.1);
        box-shadow: 0 0 15px rgba(135, 206, 250, 0.7), 0 0 5px rgba(255, 105, 180, 0.4); /* Matching input focus glow */
      }
      .colorSwatch.pinned:hover {
        transform: scale(1.12); /* Slightly more emphasis on hover */
        box-shadow: 0 0 20px rgba(135, 206, 250, 0.9), 0 0 8px rgba(255, 105, 180, 0.5);
      }
#colorInfo { /* Styles for colorInfo tooltip */
    position: fixed; 
    display: none;
    padding: 12px;
    background: rgba(10, 0, 20, 0.95); 
    backdrop-filter: blur(5px);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 0.9em;
    line-height: 1.5;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
    z-index: 550;
    pointer-events: none; 
    transition: opacity 0.15s ease-in-out; 
    max-width: 250px; /* Prevent it from being too wide */
}
      #colorInfo strong {
        color: #ffda77;
        font-size: 1.2em;
      }
      .copy-hex-button {
        display: block;
        width: 100%;
        margin-top: 10px;
        padding: 6px 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        color: #ccc;
        text-align: center;
        font-weight: bold;
        cursor: pointer;
        pointer-events: auto; /* Crucial to make it clickable inside the tooltip */
        transition: background-color 0.2s, color 0.2s;
      }
      .copy-hex-button:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }
      #leaderboardPanel {
        position: absolute;
        top: 70px; /* Adjusted dynamically or for mobile below */
        left: 20px;
        width: 280px; /* Slightly wider */
        max-height: calc(100vh - 140px); /* More dynamic height */
        background: rgba(10, 0, 20, 0.85); /* Darker, more aligned with encyclopedia */
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 15px;
        padding: 15px;
        color: white;
        pointer-events: auto;
        overflow-y: auto;
        font-size: 14px;
        display: none; /* Hidden by default, toggled by JS */
        z-index: 400; /* Below encyclopedia but above other game UI */
        box-shadow: 0 5px 25px rgba(0,0,0,0.4);
      }
      #leaderboardTitle {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        text-align: center;
        color: #ffd700; /* Gold color for title */
      }
      #leaderboardList {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      #leaderboardList li, #currentPlayerRank li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 5px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: background-color 0.2s ease;
        list-style-type: none;
      }
      #leaderboardList li:last-child {
        border-bottom: none;
      }
      #leaderboardList li:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }
      #leaderboardList li.currentUser {
        background-color: rgba(255, 218, 119, 0.15); 
        border-left: 3px solid #ffd700;
      }
      .rank {
        font-weight: bold;
        min-width: 30px;
        color: #aaa;
      }
      .playerName {
        flex-grow: 1;
        margin-left: 10px;
        color: #e0e0e0;
      }
      .score {
        font-weight: bold;
        color: #87CEFA;
      }
      @media (max-width: 768px) {
        #titleScreen {
          padding: 25px;
          max-width: 90%;
        }
        #titleScreen h1 {
          font-size: 2.5em;
        }
        #titleScreen p {
          font-size: 1.2em; 
          margin-bottom: 25px;
        }
        .authForm input {
          padding: 10px;
          font-size: 0.9em;
        }
        .authForm button {
          padding: 10px 15px;
          font-size: 0.9em;
        }
        #topBar {
          flex-direction: row; 
          flex-wrap: wrap; /* Ensure wrapping */
          gap: 5px; /* Tighter gap for mobile top bar items */
          align-items: center;
          justify-content: space-between; /* Space between main groups */
          top: 10px; 
          left: 10px;
          right: 10px;
        }
        #encyclopediaToggleButton, #leaderboardToggleButton, #battleModeButton {
            padding: 6px 10px;
            font-size: 18px;

        }
        #colorCounter {
            font-size: 14px; 
            padding: 8px 12px;

        }
        #instructions {
          font-size: 9px; 
          padding: 6px 8px; 
          text-align: left; 
          flex-basis: 100%;
          order: 3;
          margin-top: 5px;
        }
        #challengeDisplay {
            order: 4; 
            flex-basis: 100%;
            font-size: 10px;
            padding: 6px 8px;
            margin-top: 5px;
        }
        #selectedColors { 
          top: 80px;
          right: 10px;
          width: 180px; 
          max-height: calc(100vh - 200px); 
          padding: 10px;
          gap: 6px;
        }
        .selectedColor {
          padding: 6px;
        }
        .selectedColorSwatch {
          width: 24px;
          height: 24px;
          margin-right: 8px;
        }
        .selectedColorName {
          font-size: 0.85em;
        }
        #mixButton { 
          padding: 12px 25px;
          font-size: 14px;
        }

        #leaderboardPanel {

            width: calc(100% - 30px); 
            left: 15px;
            top: 60px; 
            max-height: calc(100vh - 150px); 
        }
        #fullscreenEncyclopedia {
            padding: 15px;
        }
        #fsEncyclopediaTitle {
            font-size: 1.5em;
        }
        #closeEncyclopediaButton {
            font-size: 20px;
            width: 35px;
            height: 35px;
            line-height: 35px;
        }
        .encyclopediaTabButton {
            padding: 8px 12px;
            font-size: 0.9em;
        }
        #colorGrid {
          grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); 
          gap: 8px;
        }
        #colorInfo {
          font-size: 0.9em;
          padding: 10px;
        }
      }
      .ringManagementSection {
        margin-bottom: 30px; 
        padding: 20px; 
        background-color: rgba(255, 255, 255, 0.04); 
        border-radius: 15px; /* Softer radius */
        border: 1px solid rgba(255, 255, 255, 0.1); 
        box-shadow: 0 4px 12px rgba(0,0,0,0.25); /* Enhanced shadow */
      }
      .ringManagementSectionHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .ringManagementSection h4 { /* Changed from h3 for better hierarchy if main tab title is h3 */
        margin-top: 0;
        margin-bottom: 0; /* Remove bottom margin from h4 itself */
        color: #ffda77;
        font-size: 1.3em; /* Adjusted size */
        font-family: 'Georgia', serif;
      }
      .manageRingOrbsButton {
        background-color: rgba(255, 218, 119, 0.15); /* Gold-ish accent */
        border: 1px solid rgba(255, 218, 119, 0.3);
        color: #ffda77;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s;
      }
      .manageRingOrbsButton:hover {
        background-color: rgba(255, 218, 119, 0.25);
        box-shadow: 0 0 10px rgba(255, 218, 119, 0.3);
      }
       .manageRingOrbsButton .plusIcon { /* For the plus icon */
        font-weight: bold;
        margin-right: 5px;
      }
      .ringCapacityInfo {
        font-size: 0.9em; /* Slightly smaller */
        color: #ccc; /* Lighter gray */
        margin-bottom: 15px;
      }
      .ringOrbList { /* Common style for active and available lists */
        list-style: none;
        padding-left: 0;
        margin-bottom: 20px; /* Space before available section or next ring */
      }
      .ringOrbList.activeOrbsGrid { /* Specific grid for active orbs */
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Responsive grid */
        gap: 10px;
      }
      .availableOrbsGrid { 
        display: grid;
        grid-template-columns: repeat(3, 1fr); 
        gap: 10px;
      }
      @media (max-width: 768px) {
          .availableOrbsGrid {
              grid-template-columns: repeat(2, 1fr);
          }
      }
      @media (max-width: 480px) { 
          .availableOrbsGrid {
              grid-template-columns: 1fr;
          }
      }
      .ringOrbListItem {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        background-color: rgba(0,0,0,0.3); 
        border-radius: 10px; /* Softer radius */
        border: 1px solid rgba(255,255,255,0.15);
        transition: background-color 0.2s, transform 0.15s ease-out;
      }
      .ringOrbListItem:hover {
        background-color: rgba(255,255,255,0.12);
        transform: translateY(-2px);
      }
      .ringOrbSwatch {
        width: 30px; /* Slightly larger */
        height: 30px;
        border-radius: 50%;
        margin-right: 15px; /* More space */
        border: 2px solid rgba(255,255,255,0.6); /* More prominent border */
        flex-shrink: 0;
      }
      .ringOrbName {
        font-size: 1em;
        color: #f5f5f5;
        flex-grow: 1;
      }
      .unsummonOrbButton, .summonOrbButton { 
        background-color: #ff6b6b; 
        color: white;
        border: none;
        border-radius: 6px; 
        padding: 7px 14px; 
        font-size: 0.85em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        margin-left: 10px; /* Keep some space */
      }
      .summonOrbButton {
        background-color: #4CAF50; /* Green for summon */
      }
      .unsummonOrbButton:hover, .summonOrbButton:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      .unsummonOrbButton:hover { background-color: #ee5a5a; }
      .summonOrbButton:hover { background-color: #45a049; }
      .unsummonOrbButton:active, .summonOrbButton:active {
        transform: scale(0.98);
      }
      .availableOrbsSection {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid rgba(255,255,255,0.1);
      }
      .availableOrbsSection h5 {
        color: #e0e0e0;
        font-size: 1.1em;
        margin-bottom: 10px;
      }
      #availableOrbsControls { /* For sort dropdown in available orbs */
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      #availableOrbsControls label {
        font-size: 0.9em;
        color: #ccc;
      }
      #availableOrbsSortDropdown { /* Style like other dropdowns */
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        padding: 8px 12px;
        font-size: 0.9em;
        outline: none;
      }
      #availableOrbsSortDropdown option {
        background: #1e1247;
        color: white;
      }
      .availableOrbListItem { /* Can reuse .ringOrbListItem or make specific */
         /* Uses .ringOrbListItem, but with .summonOrbButton */
      }
      /* Additional breakpoint for very small screens */
      @media (max-width: 480px) {
        #topBar {
            gap: 5px; /* Tighter gap for very small screens */
        }
        #encyclopediaToggleButton, #leaderboardToggleButton, #battleModeButton {
            font-size: 16px;
            padding: 5px 8px;
        }
        #titleScreen h1 {
          font-size: 2em;
        }
        #titleScreen p {
          font-size: 0.9em;
        }
        #instructions, #challengeDisplay {
          font-size: 9px; /* Even smaller */
        }
        .selectedColor { /* Further adjustments for very small screens */
            padding: 5px;
        }
        .selectedColorSwatch {
          width: 20px;
          height: 20px;
        }
        .selectedColorName {
          font-size: 0.8em;
        }
         #mixButton {
            padding: 10px 20px;
            font-size: 13px;
        }
        .ringOrbList {
            grid-template-columns: 1fr; /* Single column on very small screens */
        }
        .ringManagementSection h4 {
            font-size: 1.15em;
        }
        .manageRingOrbsButton {
            padding: 6px 10px;
            font-size: 0.8em;
        }
        .ringOrbListItem {
            padding: 8px 10px;
        }
        .ringOrbSwatch {
            width: 25px;
            height: 25px;
            margin-right: 10px;
        }
        .ringOrbName {
            font-size: 0.9em;
        }
        .unsummonOrbButton, .summonOrbButton {
            padding: 5px 10px;
            font-size: 0.8em;
        }
        #availableOrbsControls {
            flex-direction: column;
            align-items: flex-start;
        }
        #availableOrbsSortDropdown {
            width: 100%;
        }
        /* #encyclopediaPanel styles removed */
      }
      /* Update Screen Styles */
      .update-screen-container {
        display: none; /* Hidden by default, shown by JS */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(30, 30, 40, 0.95);
        color: #e0e0e0;
        z-index: 2000;
        /* display: none; <- This is set by JS, so we'll remove the redundant style */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        padding: 20px;
        box-sizing: border-box;
      }
      .update-modal-content {
        background-color: rgba(50, 50, 70, 0.8);
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        max-width: 500px;
        width: 90%;
      }
      #updateTitle {
        margin-top: 0;
        color: #ffffff;
      }
      #updateMessage {
        font-size: 1.1em;
        line-height: 1.6;
        min-height: 60px; /* Reserve some space */
      }
      #updateMessage progress {
        width: 100%;
        margin-top: 10px;
        margin-bottom: 5px;
      }
      .update-actions {
        margin-top: 25px;
      }
      .update-version-info {
        font-size: 0.9em;
        color: #a0a0a0;
        margin-top: 20px;
      }
      #restartButton {
        background: linear-gradient(135deg, #76c7c0, #54a19a);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 25px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(84, 161, 154, 0.3);
        /* display: none; <- This will be controlled by JS */
      }
      #restartButton:hover {
        transform: translateY(-2px) scale(1.03);
        box-shadow: 0 6px 20px rgba(84, 161, 154, 0.4);
      }
      /* Achievement Card Styles */
      .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Responsive grid */
        gap: 20px;
        padding-top: 10px; /* Space from the intro text */
      }
      .achievement-card {
        background-color: rgba(255, 255, 255, 0.03); /* Very subtle background */
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        gap: 10px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .achievement-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      }
      .achievement-card.all-tiers-completed { /* Special style if all tiers are done */
        border-left: 5px solid #ffd700; /* Gold accent for fully completed */
        background-color: rgba(255, 218, 119, 0.05); /* Faint gold glow */
      }
      .achievement-card-header {
        /* This is primarily a structural container for the title.
           The parent .achievement-card's flex properties and gap handle its spacing. */
      }
      .achievement-card-header h3 {
        font-size: 1.3em; /* Title font size */
        color: #ffda77; /* Consistent gold for titles */
        margin: 0; /* Remove default h3 margins; spacing is handled by card's padding/gap */
        font-family: 'Georgia', serif; /* Thematic font */
        line-height: 1.3; /* Good readability for the title */
      }
      .achievement-card-body {
        /* This is primarily a structural container for description and tiers.
           The parent .achievement-card's flex properties and gap handle its spacing relative to the header.
           Its children (.achievement-description, .achievement-tiers) manage their own internal spacing. */
      }
      .achievement-title {
        font-size: 1.25em;
        color: #ffda77; /* Consistent gold for titles */
        margin: 0 0 5px 0;
        font-family: 'Georgia', serif;
      }
      .achievement-description {
        font-size: 0.9em;
        color: #ccc;
        margin: 0 0 15px 0;
        line-height: 1.5;
      }
      .achievement-tiers {
        display: flex;
        flex-direction: column;
        gap: 12px; /* Increased gap for better separation */
      }
      .achievement-tier {
        background-color: rgba(0,0,0,0.2);
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid transparent; /* Placeholder for tier color */
        transition: background-color 0.2s;
        position: relative; /* Needed for absolute positioning of the tooltip */
      }
      .achievement-tier.completed {
        /* border-left-color will be set by tier type */
        background-color: rgba(0,0,0,0.1); /* Slightly different background for completed tiers */
      }
      .achievement-tier .tier-icon {
        margin-right: 8px;
        font-size: 1.1em;
      }
      .achievement-tier .tier-name {
        font-weight: bold;
        color: #f0f0f0;
      }
      .achievement-tier .tier-progress {
        font-size: 0.9em;
        color: #aaa;
        margin-left: 5px;
      }
      /* Tier-specific coloring for the left border and potentially text */
      .achievement-tier.bronze.completed { border-left-color: #CD7F32; }
      .achievement-tier.silver.completed { border-left-color: #C0C0C0; }
      .achievement-tier.gold.completed { border-left-color: #FFD700; }
      .achievement-tier.bronze .tier-name { color: #CD7F32; }
      .achievement-tier.silver .tier-name { color: #C0C0C0; }
      .achievement-tier.gold .tier-name { color: #FFD700; }
      
      .progress-bar-container {
        background-color: rgba(255,255,255,0.1);
        border-radius: 4px;
        height: 8px;
        margin-top: 8px;
        overflow: hidden; 
      }
      .progress-bar {
        height: 100%;
        background-color: #6c5ce7; 
        border-radius: 4px;
        transition: width 0.3s ease-in-out;
      }
      .achievement-tier.completed .progress-bar {
        background-color: #4CAF50; /* Green for completed */
      }
      /* Responsive adjustments for achievement cards if needed */
      @media (max-width: 768px) {
        .achievements-grid {
          grid-template-columns: 1fr;
        }
        .achievement-title {
            font-size: 1.1em;
        }
      }
      /* Tier Stats Tooltip Styles */
      .tier-stats-tooltip {
        display: block; /* Changed to block for opacity transition */
        opacity: 0; /* Start fully transparent */
        visibility: hidden; /* Start hidden */
        position: absolute;
        bottom: calc(100% + 8px); /* Position above the tier with a slightly larger gap */
        left: 50%;
        transform: translateX(-50%) translateY(5px); /* Initial slight downward offset for animation */
        background: linear-gradient(145deg, #3a2a60, #2a1a50); /* Rich purple gradient */
        color: #f0f0f0; /* Brighter text */
        padding: 8px 14px; /* More spacious padding */
        border-radius: 8px; /* Softer radius */
        font-size: 0.85em; /* Slightly larger font */
        white-space: nowrap;
        z-index: 20;
        box-shadow: 0 5px 18px rgba(0,0,0,0.6); /* More pronounced shadow */
        pointer-events: none;
        border: 1px solid rgba(255, 218, 119, 0.3); /* Subtle gold border */
        transition: opacity 0.2s ease-out, transform 0.2s ease-out, visibility 0.2s ease-out; /* Smooth transitions */
      }
      .achievement-tier:hover .tier-stats-tooltip {
        opacity: 1; /* Fade in */
        visibility: visible; /* Make visible */
        transform: translateX(-50%) translateY(0); /* Animate upwards to final position */
      }
      
      /* Ensure tier itself is clearly hoverable - already has some hover but this can enhance */
      .achievement-tier:hover {
          background-color: rgba(255,255,255,0.08); /* Slightly lighten tier background on hover */
      }
      /* Rare Achievement Tier Styling */
      .achievement-tier.rare-achievement-tier {
        /* A subtle but distinct look for very rare achievements */
        border-left-color: #ff4dff !important; /* A vibrant magenta, override other tier colors */
        box-shadow: 0 0 15px rgba(255, 77, 255, 0.5), inset 0 0 5px rgba(255, 77, 255, 0.3);
        background-color: rgba(50, 0, 50, 0.3); /* Faint magenta background */
      }
      .achievement-tier.rare-achievement-tier .tier-name {
        color: #ffafff; /* Lighter magenta for the name to stand out */
        text-shadow: 0 0 5px #ff4dff;
      }
      .achievement-tier.rare-achievement-tier.completed {
         /* Ensure completed rare achievements still look distinct */
        border-left-color: #ff4dff !important; 
      }
      /* Undiscovered Rare Achievement Tier Styling */
      .achievement-tier.undiscovered-rare-achievement-tier {
        /* A hint of rarity for tiers not yet achieved by the player */
        border-left: 4px dashed #8c008c !important; /* Darker, dashed magenta border */
        box-shadow: 0 0 10px rgba(140, 0, 140, 0.3), inset 0 0 3px rgba(140, 0, 140, 0.2);
        background-color: rgba(30, 0, 30, 0.2); /* Very faint dark magenta background */
      }
      .achievement-tier.undiscovered-rare-achievement-tier .tier-name {
        color: #e0a0e0; /* Muted magenta for the name */
        text-shadow: 0 0 3px #8c008c;
      }
      /* Ensure it doesn't clash with regular completed styles if something goes wrong */
      .achievement-tier.undiscovered-rare-achievement-tier.completed {
        border-left-color: #ff4dff !important; /* If somehow it gets 'completed' class, use the full rare style */
      }
      /* Battle Mode Screen Styles */
      #battleModeScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(145deg, #1a0a30, #0a001c); /* Dark, intense battle theme */
        color: white;
        z-index: 600; /* Above encyclopedia */
        display: none; /* Hidden by default */
        padding: 10px; /* Reduced padding */
        box-sizing: border-box;
        overflow-y: auto;
        /* display: flex; <- This was causing it to show up immediately, removed. It's set to 'none' initially. */
        flex-direction: column;
        align-items: center;
        justify-content: flex-start; /* Align content to the top */
      }
      #battleModeHeader {
        width: 100%;
        max-width: 1000px; /* Max width for content area */
        display: flex;
        /* justify-content: flex-end; No longer needed as child is removed */
        align-items: center;
        min-height: 40px; /* Ensure header has some height for the border and potential future elements */
        margin-bottom: 10px; /* Reduced margin */
        padding-bottom: 10px; /* Reduced padding */
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        position: relative; 
      }
      #battleModeTimerDisplay {
        font-size: 2em;
        color: #ffda77; /* Gold to match target color emphasis */
        font-weight: bold;
        text-shadow: 0 0 8px #ffda77;
        font-family: 'Courier New', Courier, monospace; /* Monospaced for consistent digit width */
        min-width: 80px; /* Ensure space for MM:SS */
        text-align: center;
        width: 100%; /* Center text within its column */
        margin-top: 15px; /* Space below target color display */
      }
      /* Styles for #closeBattleModeButton are removed as the button is removed */
      .battle-action-button { /* New button for Cancel/Forfeit */
        background: linear-gradient(135deg, #ff7675, #d63031); /* Reddish */
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px; /* Adjusted padding to be consistent with other buttons */
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(214, 48, 49, 0.3);
        margin-top: 15px; /* Space below timer or other central content */
        width: auto; 
        min-width: 160px; /* Good minimum width for text */
        text-align: center;
      }
      .battle-action-button:hover:not(:disabled) {
        background: linear-gradient(135deg, #e55e5d, #c22b2b);
        transform: translateY(-2px) scale(1.03);
        box-shadow: 0 4px 12px rgba(214, 48, 49, 0.4);
      }
      .battle-action-button:disabled {
        background: linear-gradient(135deg, #aaa, #888);
        cursor: not-allowed;
        opacity: 0.7;
        transform: none;
        box-shadow: none;
      }
      #battleModeContentPlaceholder {
        width: 100%;
        max-width: 1200px;
        font-size: 1.2em;
        color: #ccc;
        padding: 10px; /* Reduced padding */
        background: rgba(255,255,255,0.03);
        border-radius: 15px;
        border: 1px solid rgba(255,255,255,0.1);
        display: flex;
        justify-content: space-between;
        align-items: flex-start; 
        gap: 20px;
        flex-wrap: wrap;
      }
      .playerBattleArea {
        flex-basis: calc(35% - 20px); 
        min-width: 280px; 
        background: rgba(40, 20, 60, 0.5); 
        border: 1px solid rgba(255, 107, 107, 0.4); 
        border-radius: 12px;
        padding: 15px; /* Reduced padding */
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px; /* Reduced gap */
        box-shadow: 0 0 15px rgba(255, 107, 107, 0.2);
        position: relative;
      }
      .playerBattleTitle {
        color: #ff8b8b; /* Slightly lighter fiery red for titles */
        font-size: 1.2em; /* Further reduced font size */
        margin-bottom: 3px; /* Reduced margin */
        text-shadow: 0 0 8px #ff6b6b;
        font-family: 'Georgia', serif;
      }
      .local-player-label { /* Style for the "You (Player X)" label */
        color: #ffda77 !important; /* Gold to stand out, important to override if needed */
        text-shadow: 0 0 5px #ffda77, 0 0 10px #ff8000 !important; /* Gold shadow */
      }
      .playerBattleScore { /* New style for score display - now hidden */
        display: none; /* Hide the score display */
        /* font-size: 1.2em;
        color: #e0e0e0;
        font-weight: bold;
        margin-bottom: 3px; 
        text-align: center; */
      }
      #playerOneBattleScoreDisplay, #playerTwoBattleScoreDisplay { /* Style for the score numbers */
        color: #ffda77; /* Gold to match target color emphasis */
      }
      .playerBattleColorDisplay {
        width: 80px; /* Further reduced size */
        height: 80px; /* Further reduced size */
        background-color: rgba(0,0,0,0.3); /* Placeholder for color */
        border: 3px dashed rgba(255, 107, 107, 0.5);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255,255,255,0.4);
        font-style: italic;
        font-size: 0.9em;
        margin-bottom: 5px; /* Reduced margin */
      }
      .playerBattleColorResultInfo { /* Styles for the div showing mix results */
        min-height: 50px; /* Reduced min-height */
        width: 100%;
        max-width: 220px; /* Consistent with other elements if needed */
        text-align: center;
        font-size: 0.85em; /* Reduced font size */
        color: #ddd;
        padding: 6px; /* Reduced padding */
        background-color: rgba(0,0,0,0.15);
        border-radius: 6px;
        line-height: 1.4;
        margin-top: 10px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }
      .playerBattleColorResultInfo strong {
        color: #ffda77;
        font-size: 1.05em;
      }
      .playerBattleColorResultInfo small {
        display: block;
        font-size: 0.85em;
        color: #aaa;
        margin-top: 3px;
      }
      .playerBattleMixingZone {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px; /* Reduced gap */
        padding: 8px; /* Reduced padding */
        background-color: rgba(0,0,0,0.2);
        border-radius: 8px;
      }
      .playerBattleMixingZone h4 { /* General title for sections within mixing zone */
        margin: 2px 0 5px 0; /* Further reduced top margin */
        color: #f0f0f0;
        font-size: 1.1em;
      }
      .playerBattleSourceOrbs {
        display: grid;
        grid-template-columns: repeat(5, 28px); /* 5 columns, slightly smaller orbs */
        grid-auto-rows: 28px; /* Row height matches orb size */
        gap: 6px; /* Reduced gap */
        width: 184px; /* Accommodates 5 orbs (164px content) + tooltip space */
        /* min-height: 90px; approx 3 rows (3*28px orbs + 2*6px gaps) */
        max-height: 90px; /* Approx 3 rows */
        overflow-y: auto;
        height: auto; /* Allow container to grow vertically up to max-height */
        scrollbar-width: thin; /* For Firefox */
        scrollbar-color: rgba(255,255,255,0.3) rgba(0,0,0,0.15); /* For Firefox thumb and track */
        margin-bottom: 5px; /* Further reduced margin */
        position: relative;
      }
      .playerBattleSourceOrbs::-webkit-scrollbar {
        width: 8px;
      }
      .playerBattleSourceOrbs::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.15);
        border-radius: 4px;
      }
      .playerBattleSourceOrbs::-webkit-scrollbar-thumb {
        background-color: rgba(255,255,255,0.3);
        border-radius: 4px;
        border: 2px solid transparent;
        background-clip: content-box;
      }
      .playerBattleSourceOrbs::-webkit-scrollbar-thumb:hover {
        background-color: rgba(255,255,255,0.5);
      }
      .battle-source-orb {
        width: 28px; /* Adjusted to new grid orb size */
        height: 28px; /* Adjusted to new grid orb size */
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid rgba(255,255,255,0.7);
        box-shadow: 0 0 8px rgba(255,255,255,0.5);
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px; /* Further reduced font size for smaller orbs */
        font-weight: bold;
        color: black; 
      }
      .dynamic-battle-orb {
        /* Style for orbs created during battle */
        border: 2px dashed #ffda77 !important; /* Gold dashed border to make them stand out */
        box-shadow: 0 0 8px rgba(255, 218, 119, 0.7) !important; /* Subtle gold glow */
      }
      .battle-source-orb:hover {
        transform: scale(1.1);
        box-shadow: 0 0 12px rgba(255,255,255,0.8);
      }

      .battle-source-orb.orb-pos-r1-c1 { grid-area: 1 / 1 / 2 / 2; } /* Row 1, Col 1 */
      .battle-source-orb.orb-pos-r1-c2 { grid-area: 1 / 2 / 2 / 3; } /* Row 1, Col 2 */
      .battle-source-orb.orb-pos-r1-c3 { grid-area: 1 / 3 / 2 / 4; } /* Row 1, Col 3 */
      .battle-source-orb.orb-pos-r1-c4 { grid-area: 1 / 4 / 2 / 5; } /* Row 1, Col 4 */
      .battle-source-orb.orb-pos-r1-c5 { grid-area: 1 / 5 / 2 / 6; } /* Row 1, Col 5 */
      .battle-source-orb.orb-pos-r2-c1 { grid-area: 2 / 1 / 3 / 2; } /* Row 2, Col 1 */

      .battle-source-orb.orb-pos-r2-c5 { grid-area: 2 / 5 / 3 / 6; } /* Row 2, Col 5 */

      .playerBattleSelectedOrbs {
        display: flex;
        justify-content: center;
        gap: 8px; /* Reduced gap */
        min-height: 35px; /* Reduced min-height */
        align-items: center;
      }
      .orb-placeholder {
        width: 30px; /* Reduced size */
        height: 30px; /* Reduced size */
        background-color: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 50%;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        display: flex; /* For centering the selected orb swatch */
        align-items: center;
        justify-content: center;
      }
      .orb-placeholder.has-orb {
        border: 1px solid #ffda77; 
        background-color: transparent;
      }
      .selected-battle-orb { /* Style for the actual color swatch inside the placeholder */
        width: 25px; /* Adjusted to be smaller than new placeholder */
        height: 25px; /* Adjusted to be smaller than new placeholder */
        border-radius: 50%;
        border: 1px solid rgba(0,0,0,0.2); /* Inner border for definition */
      }
      .playerBattleControls {
        margin-top: 5px; /* Reduced margin */
      }
      .battleMixButton {
        background: linear-gradient(135deg, #ff6b6b, #e04b4b);
        border: none;
        border-radius: 20px; /* Slightly smaller radius */
        padding: 10px 20px; /* Reduced padding */
        color: white;
        font-weight: bold;
        font-size: 1em; /* Slightly reduced font size */
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }
      .battleMixButton:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
      }
      #battleModeCentralColumn {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-basis: calc(25% - 20px); /* Sizing for desktop */
        min-width: 250px; /* Sizing for desktop */
      }
      .battleTargetColorArea {
        width: 100%; /* Fill the central column */
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px; /* Reduced gap */
        padding: 10px; /* Reduced padding */
        background: rgba(0,0,0,0.2);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .battleTargetColorTitle {
        font-size: 1.1em; /* Reduced font size */
        color: #ffda77; /* Gold for emphasis */
        margin-bottom: 3px; /* Reduced margin */
        text-shadow: 0 0 8px #ffda77;
        font-family: 'Georgia', serif;
      }
      .battleTargetColorDisplay {
        width: 80px; /* Reduced size */
        height: 80px; /* Reduced size */
        background-color: rgba(50,50,50,0.8); /* Placeholder for target color */
        border: 3px solid #ffda77; /* Gold border */
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255,255,255,0.5);
        font-style: italic;
      }
      .battleTargetColorInfo {
        font-size: 0.85em;
        color: #bbb;
        text-align: center;
      }
      .battleVersusIndicator {

        font-size: 3.5em;
        color: #ff6b6b;
        align-self: center;
        font-weight: bold;
        text-shadow: 0 0 10px #ff3b3b;
        display: none; /* Hidden by default, may not be needed */
      }
      .player-ready-button {
        background: linear-gradient(135deg, #4CAF50, #388E3C); /* Green gradient */
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        margin-top: 10px; /* Space above mixing zone */
        width: 80%;
        max-width: 200px;
      }
      .player-ready-button:hover:not(:disabled) {
        background: linear-gradient(135deg, #5cb85c, #4CAF50);
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      }
      .player-ready-button:disabled {
        background: linear-gradient(135deg, #777, #555);
        cursor: not-allowed;
        opacity: 0.7;
      }
      .player-ready-status { /* Optional, if you use separate status text elements */
        font-size: 0.9em;
        color: #ccc;
        margin-top: 5px;
        text-align: center;
        min-height: 1.2em; /* Reserve space */
      }
      .player-ready-status.player-ready {
        color: #4CAF50; /* Green text when ready */
        font-weight: bold;
      }
      @media (min-width: 769px) { 
         #battleModeContentPlaceholder {
            padding: 15px; /* Reduced padding for desktop */
            justify-content: space-around; /* Ensure good spacing with target in middle */
        }
        .playerBattleArea {
            order: 1; /* Player 1 */
        }
        #playerTwoBattleArea {
            order: 3; /* Player 2 */
        }
        #battleModeCentralColumn { /* New central column for target and timer */
            order: 2; /* Target color and timer group in the middle */
        }
      }
      @media (max-width: 768px) {
        #battleModeContentPlaceholder {
          flex-direction: column; /* Stack areas */
          align-items: center; /* Center them when stacked */
        }
        .playerBattleArea {
          flex-basis: 100%; /* Full width when stacked */
          width: 90%;
          max-width: 400px; /* Max width for stacked items */
          order: 1 !important; /* Player areas come after central column (target/timer) on mobile */
        }
        #battleModeCentralColumn { /* New central column for target and timer */
            width: 90%;
            max-width: 350px;
            order: 0 !important; /* Target color and timer group appears first on mobile */
            margin-bottom: 20px; /* Space below this group on mobile */
        }
        /* .battleTargetColorArea no longer needs specific mobile width, max-width, order, or margin-bottom
           as its parent #battleModeCentralColumn handles these. It will take 100% width of its parent. */
        .playerBattleColorDisplay {
          width: 60px; /* Further reduced size for mobile */
          height: 60px; /* Further reduced size for mobile */
        }
         .battleMixButton {
            font-size: 1em;
            padding: 10px 20px;
        }
        #battleModeTimerDisplay {
            font-size: 1.4em; /* Further reduced font size on mobile */
            /* Removed position, transform, order, margin-bottom, width as they are now base or not needed for new position */
        }
        #battleModeHeader {
            /* flex-wrap and justify-content might not be strictly necessary now as only
               the absolutely positioned close button remains, but harmless to keep. */
            flex-wrap: wrap; 
            justify-content: center; 
        }
        /* #battleModeTitle and its mobile styles are removed */
        /* #closeBattleModeButton mobile styles removed */
        .battle-action-button { /* Mobile adjustments for the new action button */
            padding: 10px 18px;
            font-size: 0.9em;
            min-width: 140px;
        }
      }
      /* Styles for new dual-slider filter controls */
      .filter-group.dual-slider { margin-bottom: 15px; }
      .filter-group.dual-slider label { display: block; margin-bottom: 8px; color: #ccc; font-weight: bold; }
      .filter-group.dual-slider .sliders { display: flex; flex-direction: column; gap: 5px; }
      .filter-group.dual-slider .sliders input[type="range"] { width: 100%; margin: 0; }
      .filter-group.dual-slider .values { display: flex; justify-content: space-between; font-size: 0.9em; color: #aaa; margin-top: 5px; }

      #advancedFilterToggleContainer { display: flex; align-items: center; gap: 8px; cursor: pointer; }
      #toggleAdvancedFilters { display: none; /* Hide the actual checkbox */ }
      #toggleAdvancedFilters + label { 
          color: #ccc;
          font-size: 0.9em;
          position: relative;
          padding-left: 24px;
          user-select: none;
      }
      #toggleAdvancedFilters + label::before { /* The custom checkbox box */
          content: '';
          position: absolute;
          left: 0;
          top: 50%;
          transform: translateY(-50%);
          width: 16px;
          height: 16px;
          background: rgba(255,255,255,0.1);
          border: 1px solid rgba(255,255,255,0.3);
          border-radius: 4px;
          transition: background-color 0.2s;
      }
      #toggleAdvancedFilters:checked + label::before {
          background-color: #ffda77;
      }
      #toggleAdvancedFilters:checked + label::after { /* The checkmark */
          content: '';
          position: absolute;
          left: 3px;
          top: 50%;
          transform: translateY(-50%);
          font-size: 12px;
          color: #11001c;
          font-weight: bold;
      }
      #toggleAdvancedFilters:not(:checked) ~ #advancedFilterControls {
          display: none;
      }
      .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
        padding: 10px;
        user-select: none;
      }
      .pagination-button {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        padding: 8px 16px;
        font-size: 0.9em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
      }
      .pagination-button:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
      }
      .pagination-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .page-info {
        color: #ccc;
        font-size: 1em;
        font-weight: bold;
        min-width: 100px;
        text-align: center;
      }
      /* Settings Tab Styles */
      .settings-section {
        margin-bottom: 30px;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.04);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        max-width: 600px;
      }
      .settings-section h4 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #ffda77;
        font-size: 1.3em;
        font-family: 'Georgia', serif;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 10px;
      }
      .settings-control {
        margin-bottom: 25px;
      }
      .settings-control:last-child {
        margin-bottom: 0;
      }
      .settings-control label {
        display: block;
        margin-bottom: 10px;
        color: #ccc;
        font-size: 1em;
        font-weight: bold;
      }
      .volume-control-wrapper {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      #muteButton {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 8px;
        color: white;
        font-size: 18px;
        width: 40px;
        height: 40px;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        line-height: 40px;
        text-align: center;
        padding: 0;
      }
      #muteButton:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      #muteButton:active {
        transform: scale(0.95);
      }
      /* Generic volume slider styles */
      .volume-control-wrapper input[type="range"] {
        flex-grow: 1;
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        background: rgba(0,0,0,0.3);
        border-radius: 5px;
        outline: none;
        transition: background .2s;
      }
      .volume-control-wrapper input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #ffda77;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid #11001c;
        transition: background-color 0.2s;
      }
      .volume-control-wrapper input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #ffda77;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid #11001c;
        transition: background-color 0.2s;
      }
      .volume-control-wrapper input[type="range"]:hover::-webkit-slider-thumb { background: #ffe9a6; }
      .volume-control-wrapper input[type="range"]:hover::-moz-range-thumb { background: #ffe9a6; }
      
      /* Generic volume value text styles */
      .volume-control-wrapper span {
        font-size: 1em;
        color: #e0e0e0;
        min-width: 50px;
        text-align: right;
        font-family: 'Courier New', Courier, monospace;
      }
      #musicTrackSelector {
        width: 100%;
        max-width: 350px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        padding: 10px 12px;
        font-size: 1em;
        outline: none;
      }
      #musicTrackSelector option {
        background: #1e1247;
        color: white;
      }
      #sideNotificationContainer {
        position: fixed;
        top: 90px;
        right: 15px;
        z-index: 1500; /* High z-index to be on top of most UI elements */
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
        pointer-events: none; /* Allows clicks to pass through the container itself */
        width: 300px;
      }
      .side-notification {
        background: linear-gradient(135deg, rgba(30, 10, 60, 0.85), rgba(15, 5, 30, 0.9));
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-left: 4px solid #888; /* Default border color */
        border-radius: 8px;
        padding: 12px 16px;
        color: #e0e0e0;
        font-size: 0.9em;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        pointer-events: auto; /* Make individual notifications clickable if needed */
        animation: slideInRight 0.4s ease-out, fadeOut 0.5s ease-in-out 4.5s forwards;
        width: 100%;
        box-sizing: border-box;
      }
      .side-notification.info {
        border-left-color: #5bc0de; /* Cyan */
      }
      .side-notification.success {
        border-left-color: #28a745; /* Green */
      }
      .side-notification.warning {
        border-left-color: #ffc107; /* Yellow */
      }
      .side-notification.error {
        border-left-color: #dc3545; /* Red */
      }
      .side-notification strong {
        font-weight: bold;
        color: #ffda77; /* Gold for emphasis */
      }
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
          transform: translateX(5%); /* Slight move on fade */
          height: 0;
          padding-top: 0;
          padding-bottom: 0;
          margin-bottom: 0;
          border-width: 0;
        }
      }
      #sideNotificationContainer > .side-notification:not(:last-child) {
        margin-bottom: 10px; /* This is handled by the parent's gap property, but as a fallback */
      }
    </style>
  </head>
  <body>
    <canvas id="titleParticlesCanvas"></canvas>
    <!-- Update Screen -->
    <div id="updateScreen" class="update-screen-container">
        <div class="update-modal-content">
            <h2 id="updateTitle">Game Update</h2>
            <p id="updateMessage"></p>
            <div class="update-actions">
                <button id="restartButton">Restart and Install</button>
            </div>
            <p class="update-version-info" id="updateVersionInfo"></p>
        </div>
    </div>
    <div id="gameContainer">
      <div id="titleScreen">
        <h1>#HEXXED</h1>
        <p>Mix colors, discover new hues, and master the spectrum!</p>
        <div class="authForm">
          <input type="text" id="usernameInput" placeholder="Username">
          <input type="password" id="passwordInput" placeholder="Password">
          <button id="loginButton">Log In</button>
          <button id="signupButton">Sign Up</button>
        </div>
        <div id="authMessage"></div>
      </div>
      <div id="gameArea"> 
        <div id="topBar">
          <button id="encyclopediaToggleButton" title="Open Encyclopedia"></button>
          <button id="leaderboardToggleButton" title="Toggle Leaderboard"></button>
          <button id="battleModeButton" title="Enter Battle Mode"></button> <!-- Battle Mode Button -->
          <div id="colorCounter">Colors: <span id="colorCount">3</span></div>
          <div id="instructions">Click orbs to select  Mix colors to discover new ones</div>
          <div id="challengeDisplay">Current Challenge: Find a specific color!</div>
        </div>
        <div id="selectedColors"></div>
        <div id="leaderboardPanel">
          <!-- Leaderboard content will be injected by leaderboard.js -->
        </div>
      </div>
      <div id="fullscreenEncyclopedia">
        <div id="fsEncyclopediaHeader">
          <h2 id="fsEncyclopediaTitle">#HEXXED Codex</h2>
          <button id="closeEncyclopediaButton">&times;</button>
        </div>
        <div id="encyclopediaTabs">
          <button class="encyclopediaTabButton active" data-tab="colorGridTab">Color Grid</button>
          <button class="encyclopediaTabButton" data-tab="colorRingsTab">Color Rings</button>
          <button class="encyclopediaTabButton" data-tab="achievementsTab">Achievements</button>
          <button class="encyclopediaTabButton" data-tab="settingsTab">Settings</button>
        </div>
        <div id="encyclopediaTabContent">
          <div id="colorGridTab" class="encyclopediaTabPanel active">
            <div id="encyclopediaControls" style="display: flex; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;">
              <label for="sortColorsDropdown">Sort by:</label>
              <select id="sortColorsDropdown">
                <option value="name_asc">Name (A-Z)</option>
                <option value="name_desc">Name (Z-A)</option>
                <option value="discovered_asc">Oldest Discovered</option>
                <option value="discovered_desc">Newest Discovered</option>
                <option value="hue_asc">Hue (Ascending)</option>
                <option value="hue_desc">Hue (Descending)</option>
                <option value="saturation_asc">Saturation (Low-High)</option>
                <option value="saturation_desc">Saturation (High-Low)</option>
                <option value="lightness_asc">Lightness (Dark-Light)</option>
                <option value="lightness_desc">Lightness (Light-Dark)</option>
                <option value="mix_arity_asc">Complexity (Low-High)</option>
                <option value="mix_arity_desc">Complexity (High-Low)</option>
              </select>
              <label for="encyclopediaColorFilterInput" style="margin-left: 15px;">Filter by Name:</label>
              <input type="text" id="encyclopediaColorFilterInput" placeholder="e.g., 'Azure' or 'Sky'" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; padding: 8px 12px; font-size: 0.9em; outline: none;">
              <div id="advancedFilterToggleContainer">
                <input type="checkbox" id="advancedFiltersToggle">
                <label for="advancedFiltersToggle">Advanced Filters</label>
              </div>
            </div>
            <div id="advanced-filters-container" style="margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- HSL Section -->
                    <div>
                        <h5 style="color: #ffda77; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid rgba(255,218,119,0.3); padding-bottom: 5px;">HSL Filters</h5>
                        <div class="filter-group dual-slider">
                            <label>Hue Range (0-360)</label>
                            <div class="sliders">
                                <input type="range" id="encyclopediaHueMinSlider" min="0" max="360" value="0">
                                <input type="range" id="encyclopediaHueMaxSlider" min="0" max="360" value="360">
                            </div>
                            <div class="values"><span>Min: <span id="encyclopediaHueMinValue">0</span></span><span>Max: <span id="encyclopediaHueMaxValue">360</span></span></div>
                        </div>
                        <div class="filter-group dual-slider">
                            <label>Saturation Range (0-100)</label>
                            <div class="sliders">
                                <input type="range" id="encyclopediaSaturationMinSlider" min="0" max="100" value="0">
                                <input type="range" id="encyclopediaSaturationMaxSlider" min="0" max="100" value="100">
                            </div>
                            <div class="values"><span>Min: <span id="encyclopediaSaturationMinValue">0</span>%</span><span>Max: <span id="encyclopediaSaturationMaxValue">100</span>%</span></div>
                        </div>
                        <div class="filter-group dual-slider">
                            <label>Lightness Range (0-100)</label>
                            <div class="sliders">
                                <input type="range" id="encyclopediaLightnessMinSlider" min="0" max="100" value="0">
                                <input type="range" id="encyclopediaLightnessMaxSlider" min="0" max="100" value="100">
                            </div>
                            <div class="values"><span>Min: <span id="encyclopediaLightnessMinValue">0</span>%</span><span>Max: <span id="encyclopediaLightnessMaxValue">100</span>%</span></div>
                        </div>
                    </div>
                    <!-- RGB Section -->
                    <div>
                        <h5 style="color: #ffda77; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid rgba(255,218,119,0.3); padding-bottom: 5px;">RGB Filters</h5>
                        <div class="filter-group dual-slider">
                            <label>Red Range (0-255)</label>
                            <div class="sliders">
                                <input type="range" id="encyclopediaRedMinSlider" min="0" max="255" value="0">
                                <input type="range" id="encyclopediaRedMaxSlider" min="0" max="255" value="255">
                            </div>
                            <div class="values"><span>Min: <span id="encyclopediaRedMinValue">0</span></span><span>Max: <span id="encyclopediaRedMaxValue">255</span></span></div>
                        </div>
                        <div class="filter-group dual-slider">
                            <label>Green Range (0-255)</label>
                            <div class="sliders">
                                <input type="range" id="encyclopediaGreenMinSlider" min="0" max="255" value="0">
                                <input type="range" id="encyclopediaGreenMaxSlider" min="0" max="255" value="255">
                            </div>
                            <div class="values"><span>Min: <span id="encyclopediaGreenMinValue">0</span></span><span>Max: <span id="encyclopediaGreenMaxValue">255</span></span></div>
                        </div>
                        <div class="filter-group dual-slider">
                            <label>Blue Range (0-255)</label>
                            <div class="sliders">
                                <input type="range" id="encyclopediaBlueMinSlider" min="0" max="255" value="0">
                                <input type="range" id="encyclopediaBlueMaxSlider" min="0" max="255" value="255">
                            </div>
                            <div class="values"><span>Min: <span id="encyclopediaBlueMinValue">0</span></span><span>Max: <span id="encyclopediaBlueMaxValue">255</span></span></div>
                        </div>
                    </div>
                </div>
                <button id="resetFiltersButton" style="margin-top: 20px; padding: 8px 16px; background: rgba(255,107,107,0.7); border: none; color: white; border-radius: 6px; cursor: pointer;">Reset All Filters</button>
            </div>
            <div id="colorGrid"></div>
            <div class="pagination-controls" id="colorGridPagination">
                <button class="pagination-button" id="colorGridPrevPage" disabled>&lt; Prev</button>
                <span class="page-info" id="colorGridPageInfo">Page 1 / 1</span>
                <button class="pagination-button" id="colorGridNextPage" disabled>Next &gt;</button>
            </div>
            <div id="colorInfo">Select a color to see details.</div>
          </div>
          <div id="colorRingsTab" class="encyclopediaTabPanel">
            <!-- This content will be dynamically populated by UIManager.js -->
            <!-- Example Structure for one ring type (e.g., 2-Color Mix Ring) -->
            <!-- UIManager will create these sections for 2, 3, and 4-color mixes -->
            
            <!-- Section for 2-Color Mix Ring -->
            <div class="ringManagementSection" id="ringSection-2">
              <div class="ringManagementSectionHeader">
                <h4>2-Color Mix Ring</h4>
                <button class="manageRingOrbsButton" data-arity="2"><span class="plusIcon">+</span> Manage Orbs</button>
              </div>
              <p class="ringCapacityInfo">Active Orbs: <span id="activeOrbsCount-2">0</span> / <span id="maxOrbsCount-2">9</span></p>
              <h5>Active Orbs:</h5>
              <ul class="ringOrbList activeOrbsGrid" id="activeOrbsList-2">
                <!-- Populated by JS: e.g. -->
                <!-- 
                <li class="ringOrbListItem">
                  <div class="ringOrbSwatch" style="background-color: #FF5733;"></div>
                  <span class="ringOrbName">Fiery Orange</span>
                  <button class="unsummonOrbButton" data-orb-hex="#FF5733">Unsummon</button>
                </li>
                -->
              </ul>
              <div class="availableOrbsSection" id="availableOrbsSection-2" style="display: none;"> <!-- Initially hidden, shown by "Manage Orbs" -->
                <h5>Available to Summon:</h5>
                <div class="availableOrbsControls" id="availableOrbsControls-2">
                  <label for="availableOrbsSortDropdown-2">Sort by:</label>
                  <select id="availableOrbsSortDropdown-2" class="availableOrbsSortDropdown" data-arity="2">
                    <!-- Options similar to #sortColorsDropdown -->
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                    <option value="discovered_asc">Oldest Discovered</option>
                    <option value="discovered_desc">Newest Discovered</option>
                    <option value="hue_asc">Hue</option>
                    <!-- Add other relevant sort options -->
                  </select>
                  <label for="availableOrbsFilterInput-2" style="margin-left: 10px;">Filter:</label>
                  <input type="text" id="availableOrbsFilterInput-2" class="availableOrbsFilterInput" placeholder="Filter by name..." data-arity="2">
                </div>
                <ul class="ringOrbList" id="availableOrbsList-2">
                  <!-- Populated by JS: e.g. -->
                  <!--
                  <li class="ringOrbListItem availableOrbListItem">
                    <div class="ringOrbSwatch" style="background-color: #33FF57;"></div>
                    <span class="ringOrbName">Bright Lime</span>
                    <button class="summonOrbButton" data-orb-hex="#33FF57">Summon</button>
                  </li>
                  -->
                </ul>
              </div>
              <div class="pagination-controls" id="summonablePagination-2">
                  <button class="pagination-button" id="summonablePrevPage-2" disabled>&lt; Prev</button>
                  <span class="page-info" id="summonablePageInfo-2">Page 1 / 1</span>
                  <button class="pagination-button" id="summonableNextPage-2" disabled>Next &gt;</button>
              </div>
            </div>
            <!-- Section for 3-Color Mix Ring (similar structure) -->
            <div class="ringManagementSection" id="ringSection-3">
              <div class="ringManagementSectionHeader">
                <h4>3-Color Mix Ring</h4>
                <button class="manageRingOrbsButton" data-arity="3"><span class="plusIcon">+</span> Manage Orbs</button>
              </div>
              <p class="ringCapacityInfo">Active Orbs: <span id="activeOrbsCount-3">0</span> / <span id="maxOrbsCount-3">18</span></p>
              <h5>Active Orbs:</h5>
              <ul class="ringOrbList activeOrbsGrid" id="activeOrbsList-3"></ul>
              <div class="availableOrbsSection" id="availableOrbsSection-3" style="display: none;">
                <h5>Available to Summon:</h5>
                <div class="availableOrbsControls" id="availableOrbsControls-3">
                  <label for="availableOrbsSortDropdown-3">Sort by:</label>
                  <select id="availableOrbsSortDropdown-3" class="availableOrbsSortDropdown" data-arity="3">
                     <option value="name_asc">Name (A-Z)</option>
                     <!-- other options -->
                  </select>
                  <label for="availableOrbsFilterInput-3" style="margin-left: 10px;">Filter:</label>
                  <input type="text" id="availableOrbsFilterInput-3" class="availableOrbsFilterInput" placeholder="Filter by name..." data-arity="3">
                </div>
                <ul class="ringOrbList" id="availableOrbsList-3"></ul>
              </div>
              <div class="pagination-controls" id="summonablePagination-3">
                  <button class="pagination-button" id="summonablePrevPage-3" disabled>&lt; Prev</button>
                  <span class="page-info" id="summonablePageInfo-3">Page 1 / 1</span>
                  <button class="pagination-button" id="summonableNextPage-3" disabled>Next &gt;</button>
              </div>
            </div>
            <!-- Section for 4-Color Mix Ring (similar structure) -->
            <div class="ringManagementSection" id="ringSection-4">
              <div class="ringManagementSectionHeader">
                <h4>4-Color Mix Ring</h4>
                <button class="manageRingOrbsButton" data-arity="4"><span class="plusIcon">+</span> Manage Orbs</button>
              </div>
              <p class="ringCapacityInfo">Active Orbs: <span id="activeOrbsCount-4">0</span> / <span id="maxOrbsCount-4">30</span></p>
              <h5>Active Orbs:</h5>
              <ul class="ringOrbList activeOrbsGrid" id="activeOrbsList-4"></ul>
              <div class="availableOrbsSection" id="availableOrbsSection-4" style="display: none;">
                <h5>Available to Summon:</h5>
                 <div class="availableOrbsControls" id="availableOrbsControls-4">
                  <label for="availableOrbsSortDropdown-4">Sort by:</label>
                  <select id="availableOrbsSortDropdown-4" class="availableOrbsSortDropdown" data-arity="4">
                     <option value="name_asc">Name (A-Z)</option>
                     <!-- other options -->
                  </select>
                  <label for="availableOrbsFilterInput-4" style="margin-left: 10px;">Filter:</label>
                  <input type="text" id="availableOrbsFilterInput-4" class="availableOrbsFilterInput" placeholder="Filter by name..." data-arity="4">
                </div>
                <ul class="ringOrbList" id="availableOrbsList-4"></ul>
              </div>
              <div class="pagination-controls" id="summonablePagination-4">
                  <button class="pagination-button" id="summonablePrevPage-4" disabled>&lt; Prev</button>
                  <span class="page-info" id="summonablePageInfo-4">Page 1 / 1</span>
                  <button class="pagination-button" id="summonableNextPage-4" disabled>Next &gt;</button>
              </div>
            </div>
          </div>
          <div id="achievementsTab" class="encyclopediaTabPanel">
            <!-- Achievements content will be populated by UIManager.js -->
            <h4>Achievements</h4>
            <p>Track your progress and unlock special rewards!</p>
            <div id="achievementsList">
              <!-- UIManager will populate this list -->
            </div>
            </div>
            <div id="settingsTab" class="encyclopediaTabPanel">
              <div class="settings-section">
                  <h4>Audio Settings</h4>
                  <div class="settings-control">
                      <label>Master Volume</label>
                      <div class="volume-control-wrapper">
                          <button id="muteButton" title="Toggle Mute"></button>
                          <input type="range" id="masterVolumeSlider" min="0" max="1" step="0.01" value="0.5">
                          <span id="masterVolumeValue">50%</span>
                      </div>
                  </div>
                  <div class="settings-control">
                      <label>Music Volume</label>
                      <div class="volume-control-wrapper">
                          <input type="range" id="musicVolumeSlider" min="0" max="1" step="0.01" value="1.0">
                          <span id="musicVolumeValue">100%</span>
                      </div>
                  </div>
                  <div class="settings-control">
                      <label>Sound Effects Volume</label>
                      <div class="volume-control-wrapper">
                          <input type="range" id="sfxVolumeSlider" min="0" max="1" step="0.01" value="1.0">
                          <span id="sfxVolumeValue">100%</span>
                      </div>
                  </div>
                  <div class="settings-control">
                      <label>Achievement Sounds</label> <!-- Changed label -->
                      <div id="advancedFilterToggleContainer"> <!-- Re-using style for a toggle switch -->
                        <input type="checkbox" id="toggleAchievementSounds" checked>
                        <label for="toggleAchievementSounds">Enable Achievement Sounds</label>
                      </div>
                  </div>
                  <div class="settings-control">
                      <label>Achievement Sounds Volume</label>
                      <div class="volume-control-wrapper">
                          <input type="range" id="achievementVolumeSlider" min="0" max="1" step="0.01" value="1.0">
                          <span id="achievementVolumeValue">100%</span>
                      </div>
                  </div>
                  <div class="settings-control">
                      <label for="musicTrackSelector">Background Music</label>
                      <select id="musicTrackSelector"></select>
                  </div>
              </div>
            </div>
          </div>
          </div>
      <div id="battleModeScreen"> <!-- Battle Mode Screen Container -->
        <div id="battleModeHeader">
          <!-- Close button removed from here -->
        </div>
        <div id="battleModeContentPlaceholder">
          <div class="playerBattleArea" id="playerOneBattleArea">
            <h3 id="playerOneBattleLabel" class="playerBattleTitle">Player 1</h3>
            <div class="playerBattleScore">Score: <span id="playerOneBattleScoreDisplay">0</span></div>
            <button id="playerOneReadyButton" class="player-ready-button">Ready?</button>
            <div id="playerOneReadyStatus" class="player-ready-status">Not Ready</div>
            <div class="playerBattleColorDisplay" id="playerOneColorDisplay">
              <p>Your Color</p>
            </div>
            <div id="playerOneColorResultInfo" class="playerBattleColorResultInfo">
              <!-- Opponent/Player 1 mix details will appear here -->
            </div>
            <div class="playerBattleMixingZone">
              <h4>Available Orbs</h4>
              <div class="playerBattleSourceOrbs" id="playerOneSourceOrbs">
                <!-- Player 1's 7 starting orbs will be rendered here by UIManager.js -->
              </div>
              <h4>Selected for Mix</h4>
              <div class="playerBattleSelectedOrbs" id="playerOneSelectedOrbs">
                <div class="orb-placeholder"></div>
                <div class="orb-placeholder"></div>
                <div class="orb-placeholder"></div>
                <div class="orb-placeholder"></div>
              </div>
              <div class="playerBattleControls" id="playerOneControls">
                <button class="battleMixButton" id="playerOneMixButton">Mix!</button>
              </div>
            </div>
          </div>
          <div id="battleModeCentralColumn">
            <div class="battleTargetColorArea">
              <h3 class="battleTargetColorTitle">Target Color</h3>
              <div class="battleTargetColorDisplay" id="targetBattleColorDisplay">
                <p>?</p>
              </div>
              <div class="battleTargetColorInfo" id="targetBattleColorInfo">
                <!-- RGB/HSL info will go here -->
              </div>
            </div>
            <div id="battleModeTimerDisplay">00:00</div>
            <button id="battleModeActionButton" class="battle-action-button">Cancel Match</button>
          </div>
          <div class="playerBattleArea" id="playerTwoBattleArea">
            <h3 id="playerTwoBattleLabel" class="playerBattleTitle">Player 2</h3>
            <div class="playerBattleScore">Score: <span id="playerTwoBattleScoreDisplay">0</span></div> <!-- Also added for P2 for consistency -->
            <button id="playerTwoReadyButton" class="player-ready-button">Ready?</button>
            <div id="playerTwoReadyStatus" class="player-ready-status">Not Ready</div>
            <div class="playerBattleColorDisplay" id="playerTwoColorDisplay">
              <p>Your Color</p>
            </div>
            <div id="playerTwoColorResultInfo" class="playerBattleColorResultInfo">
              <!-- Opponent/Player 2 mix details will appear here -->
            </div>
            <div class="playerBattleMixingZone">
              <h4>Available Orbs</h4> <!-- Changed from "Select Orbs" for consistency -->
              <div class="playerBattleSourceOrbs" id="playerTwoSourceOrbs">
                <!-- Player 2's starting orbs will be rendered here by UIManager.js -->
              </div>
              <h4>Selected for Mix</h4> <!-- Added for consistency -->
              <div class="playerBattleSelectedOrbs" id="playerTwoSelectedOrbs">
                <div class="orb-placeholder"></div>
                <div class="orb-placeholder"></div>
                <div class="orb-placeholder"></div>
                <div class="orb-placeholder"></div>
              </div>
              <div class="playerBattleControls" id="playerTwoControls">
                <button class="battleMixButton" id="playerTwoMixButton">Mix!</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Battle Results Screen -->
<div id="battleResultsScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.75); z-index: 1001; justify-content: center; align-items: center;">
        <div id="battleResultsContent" style="background: linear-gradient(145deg, #2c2c54, #1a1a3a); padding: 20px; border-radius: 15px; text-align: center; color: white; box-shadow: 0 0 25px rgba(0,0,0,0.6); width: 90%; max-width: 500px; max-height: 95vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); position: relative;">
            <h2 style="color: #ffda77; font-family: 'Georgia', serif; font-size: 1.8em; margin-bottom: 10px; text-shadow: 0 0 8px #ffda77;">Battle Results</h2>
            <p id="battleWinnerMessage" style="font-size: 1.3em; font-weight: bold; margin-bottom: 20px; color: #ff6b6b;"></p>
            
            <div style="margin-bottom: 20px; padding: 15px; background-color: rgba(255,255,255,0.05); border-radius: 10px;">
                <h3 style="color: #ccc; margin-bottom: 8px; font-size: 1.1em; margin-top: 0;">Target Color</h3>
                <div id="targetColorResultSwatch" style="width: 70px; height: 70px; margin: 0 auto 10px auto; border: 3px solid #ffda77; border-radius: 8px; box-shadow: 0 0 10px rgba(255,218,119,0.5);"></div>
                <p id="targetColorResultInfo" style="font-size: 0.9em; line-height: 1.4; margin:0;"></p>
            </div>
            <div style="display: flex; justify-content: space-around; margin-bottom: 20px; flex-wrap: nowrap; gap: 15px;">
                <div class="player-result-container" style="flex: 1; min-width: 0; padding: 10px; background-color: rgba(255,255,255,0.05); border-radius: 10px;">
                    <h4 id="playerOneResultLabel" style="color: #ccc; margin-bottom: 8px; font-size: 1em; margin-top: 0;">Player 1</h4>
                    <div id="playerOneResultSwatch" style="width: 60px; height: 60px; margin: 0 auto 10px auto; border: 3px solid #fff; border-radius: 8px; background-color: #333; box-shadow: 0 0 8px rgba(255,255,255,0.3);"></div>
                    <p id="playerOneResultInfo" style="font-size: 0.85em; line-height: 1.3; margin:0; word-wrap: break-word;"></p>
                </div>
                <div class="player-result-container" style="flex: 1; min-width: 0; padding: 10px; background-color: rgba(255,255,255,0.05); border-radius: 10px;">
                    <h4 id="playerTwoResultLabel" style="color: #ccc; margin-bottom: 8px; font-size: 1em; margin-top: 0;">Player 2</h4>
                    <div id="playerTwoResultSwatch" style="width: 60px; height: 60px; margin: 0 auto 10px auto; border: 3px solid #fff; border-radius: 8px; background-color: #333; box-shadow: 0 0 8px rgba(255,255,255,0.3);"></div>
                    <p id="playerTwoResultInfo" style="font-size: 0.85em; line-height: 1.3; margin:0; word-wrap: break-word;"></p>
                </div>
            </div>
            <button id="closeBattleResultsButton" style="padding: 10px 20px; font-size: 1em; background: linear-gradient(135deg, #ff8b8b, #ff6b6b); color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, transform 0.2s; box-shadow: 0 3px 10px rgba(255,107,107,0.3); margin-top: 10px;">Close</button>
        </div>
      </div>
      <!-- Lobby Screen -->
      <div id="lobbyScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1002; justify-content: center; align-items: center; flex-direction: column; color: white; font-family: 'Arial', sans-serif; display: none;">
        <div style="background: linear-gradient(145deg, #3a3a7e, #2a2a5a); padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.1);">
            <h2 style="color: #a29bfe; font-size: 2.2em; margin-bottom: 25px; text-shadow: 0 0 10px #a29bfe;">Game Lobby</h2>
            <p id="lobbyStatusMessage" style="font-size: 1.4em; margin-bottom: 30px; min-height: 30px;">Initializing...</p>
            <div class="spinner" style="width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #a29bfe; animation: spin 1s ease-in-out infinite; margin: 0 auto 30px auto;"></div>
            <button id="cancelLobbyButton" style="padding: 12px 30px; font-size: 1.1em; background: linear-gradient(135deg, #ff7675, #d63031); color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, transform 0.2s; box-shadow: 0 3px 10px rgba(255,118,117,0.3);">Cancel</button>
        </div>
      </div>
    </div>
    
    <!-- Side Notification Container -->
    <div id="sideNotificationContainer"></div>
    
    <script type="module" src="./main.js"></script>
    <script type="module" src="./titleParticles.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ScriptsLoader-Universal.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ChatManager.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ImageGenerator.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ProgressLogger.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/OGP.js"></script>
  </body>
</html>